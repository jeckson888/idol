<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>再一，再二，再三</title>
    
    <!-- PWA 支持 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="再一，再二，再三">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- 图标 -->
    <link rel="icon" type="image/jpeg" href="img/icon.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="img/icon.jpg">
    <link rel="apple-touch-icon" href="img/icon.jpg">
    <meta name="msapplication-TileImage" content="img/icon.jpg">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- LeanCloud SDK（国内可访问） -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <!-- 和风天气API -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 动画库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- 图片懒加载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js"></script>
</head>
<body>
    <!-- 背景图片 -->
    <div id="background-container">
        <div class="background-overlay"></div>
    </div>

                    <!-- 背景音乐 -->
                <audio id="bgMusic" loop>
                    <source src="img/bg_music.mp3" type="audio/mpeg">
                </audio>
    
    <!-- 音乐控制按钮 -->
    <div class="music-control">
        <button id="musicToggle" class="music-btn">
            <i class="fas fa-music"></i>
        </button>
        <div class="music-info">
            <span id="musicStatus">音乐已暂停</span>
        </div>
        <button id="musicListBtn" class="music-list-btn" title="音乐列表">
            <i class="fas fa-list"></i>
        </button>
        <button id="musicPrevBtn" class="music-nav-btn" title="上一首">
            <i class="fas fa-step-backward"></i>
        </button>
        <button id="musicNextBtn" class="music-nav-btn" title="下一首">
            <i class="fas fa-step-forward"></i>
        </button>
    </div>

    <!-- 音乐列表弹窗 -->
    <div id="musicListModal" class="music-list-modal" style="display: none;">
        <div class="music-list-content">
            <div class="music-list-header">
                <h3>背景音乐列表</h3>
                <button class="close-btn" onclick="closeMusicList()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="music-list-body">
                <div class="music-upload-section">
                    <label class="upload-music-btn">
                        <i class="fas fa-plus"></i> 添加音乐
                        <input type="file" id="musicUploadInput" accept="audio/*" multiple style="display: none;">
                    </label>
                </div>
                <div id="musicListContainer" class="music-list-container">
                    <!-- 音乐列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    

    <!-- 登录页面 -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1><i class="fas fa-heart"></i> 再一，再二，再三</h1>
                <p>记录与偶像的美好时光</p>
            </div>
            
            <div class="quick-login">
                <h3>快速登录</h3>
                <div class="user-cards">
                    <div class="user-card" onclick="quickLogin('demo_user', '123456')">
                        <img src="img/icon.jpg" alt="用户头像">
                        <div class="user-info">
                            <h4>再一,再二,再三</h4>
                            <p>玊٠尔</p>
                        </div>
                    </div>

                </div>
            </div>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <input type="text" id="username" placeholder="用户名" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="密码" required>
                </div>
                <button type="submit" class="login-btn">登录</button>
            </form>
        </div>
    </div>

    <!-- 主应用页面 -->
    <div id="appPage" class="app-container" style="display: none;">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-heart"></i>
                <span>再一，再二，再三</span>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="nav-link active" data-page="home">首页</a></li>
                <li><a href="#" class="nav-link" data-page="diary">动态</a></li>
                <li><a href="#" class="nav-link" data-page="gallery">相册</a></li>
                <li><a href="#" class="nav-link" data-page="timeline">时间线</a></li>
                <li><a href="#" class="nav-link" data-page="profile">个人资料</a></li>
            </ul>
            <div class="nav-user">
                <img id="userAvatar" src="img/icon.jpg" alt="用户头像">
                <span id="userName">用户</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </nav>

        <!-- 首页 -->
        <div id="homePage" class="page active">
            <div class="hero-section">
                <div class="hero-content">
                    <h1>欢迎回来，<span id="heroUserName">偶像粉丝</span>！</h1>
                    <p>记录与偶像的每一个美好瞬间</p>
                    <div class="hero-buttons">
                        <button class="btn btn-primary" onclick="showPage('diary')">
                            <i class="fas fa-plus"></i> 发布新动态
                        </button>
                        <button class="btn btn-secondary" onclick="showPage('gallery')">
                            <i class="fas fa-images"></i> 查看相册
                        </button>
                    </div>
                </div>

            </div>

            <div class="stats-section">
                <div class="stat-card">
                    <i class="fas fa-pen"></i>
                    <h3 id="totalPosts">0</h3>
                    <p>动态数</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-image"></i>
                    <h3 id="totalImages">0</h3>
                    <p>图片数</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-music"></i>
                    <h3 id="totalMusic">0</h3>
                    <p>音乐数</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-heart"></i>
                    <h3 id="totalLikes">0</h3>
                    <p>点赞数</p>
                </div>
            </div>

            <div class="recent-posts">
                <h2>最近动态</h2>
                <div id="recentPostsGrid" class="recent-posts-grid">
                    <!-- 动态内容将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 动态页面 -->
        <div id="diaryPage" class="page">
            <div class="page-header">
                <h2>我的动态</h2>
                <button class="new-post-btn" onclick="showNewPostForm()">
                    <i class="fas fa-plus"></i> 发布动态
                </button>
            </div>

            <div id="newPostForm" class="new-post-form" style="display: none;">
                <h3>发布新动态</h3>
                <div class="form-group">
                    <textarea id="postContent" placeholder="分享你的想法..." rows="4"></textarea>
                </div>
                <div class="media-upload">
                    <label class="upload-btn">
                        <i class="fas fa-image"></i> 添加图片
                        <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                    </label>
                    <label class="upload-btn">
                        <i class="fas fa-video"></i> 添加视频
                        <input type="file" id="videoUpload" accept="video/*" multiple style="display: none;">
                    </label>
                    <label class="upload-btn">
                        <i class="fas fa-music"></i> 添加音乐
                        <input type="file" id="musicUpload" accept="audio/*" multiple style="display: none;">
                    </label>
                </div>
                <div id="mediaPreview" class="media-preview"></div>
                <div class="form-actions">
                    <button class="submit-btn" onclick="createPost()">发布</button>
                    <button class="cancel-btn" onclick="hideNewPostForm()">取消</button>
                </div>
            </div>

            <div id="postsContainer" class="posts-container">
                <!-- 动态内容将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 相册页面 -->
        <div id="galleryPage" class="page">
            <div class="page-header">
                <h2>我的相册</h2>
                <div class="gallery-controls">
                    <button class="view-btn active" onclick="switchGalleryView('grid')">
                        <i class="fas fa-th"></i> 网格
                    </button>
                    <button class="view-btn" onclick="switchGalleryView('list')">
                        <i class="fas fa-list"></i> 列表
                    </button>
                </div>
            </div>
            <div id="galleryContainer" class="gallery-container">
                <!-- 相册内容将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 时间线页面 -->
        <div id="timelinePage" class="page">
            <div class="page-header">
                <h2>时间线</h2>
            </div>
            <div id="timelineContainer" class="timeline-container">
                <!-- 时间线内容将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 个人资料页面 -->
        <div id="profilePage" class="page">
            <div class="page-header">
                <h2>个人资料</h2>
            </div>
            <div class="profile-content">
                <div class="profile-avatar">
                    <img id="profileAvatar" src="img/icon.jpg" alt="头像">
                    <button class="change-avatar-btn" onclick="changeAvatar()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="info-group">
                    <label>用户名</label>
                    <input type="text" id="profileUsername" readonly>
                </div>
                <div class="info-group">
                    <label>昵称</label>
                    <input type="text" id="profileNickname" placeholder="输入昵称">
                </div>
                <div class="info-group">
                    <label>个人简介</label>
                    <textarea id="profileBio" placeholder="介绍一下自己..."></textarea>
                </div>
                <div class="info-group">
                    <label>我的偶像</label>
                    <input type="text" id="profileIdol" placeholder="输入偶像名字">
                </div>
                <div class="info-group">
                    <label>加入时间</label>
                    <input type="text" id="profileJoinDate" readonly>
                </div>
                <button class="save-profile-btn" onclick="saveProfile()">
                    <i class="fas fa-save"></i> 保存资料
                </button>
            </div>
        </div>
    </div>

    <!-- PWA 安装提示 -->
    <div id="pwaInstallPrompt" class="pwa-install-prompt" style="display: none;">
        <div class="pwa-install-content">
            <i class="fas fa-download"></i>
            <h3>安装应用</h3>
            <p>将再一，再二，再三添加到主屏幕，获得更好的体验</p>
            <div class="pwa-install-buttons">
                <button id="pwaInstallBtn" class="pwa-install-btn">安装</button>
                <button id="pwaDismissBtn" class="pwa-dismiss-btn">稍后</button>
            </div>
        </div>
    </div>



    <script src="js/config.js"></script>
    <script src="js/demo-data.js"></script>
    <script src="js/backend.js"></script>
    <script>
      // 初始化后端适配器
      document.addEventListener('DOMContentLoaded', async () => {
        window.backend = new BackendAdapter(window.CONFIG);
        await window.backend.init();
      });
    </script>
    <script src="js/third-party.js"></script>
    <script src="js/app.js"></script>
    
    <!-- PWA Service Worker 注册 -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA 安装提示
        let deferredPrompt;
        const pwaInstallPrompt = document.getElementById('pwaInstallPrompt');
        const pwaInstallBtn = document.getElementById('pwaInstallBtn');
        const pwaDismissBtn = document.getElementById('pwaDismissBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt event fired');
            e.preventDefault();
            deferredPrompt = e;
            pwaInstallPrompt.style.display = 'block';
        });

        // 检查是否已经安装
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
            console.log('应用已安装为PWA');
        }

        // 手动显示安装提示（用于测试）
        function showInstallPrompt() {
            if (deferredPrompt) {
                pwaInstallPrompt.style.display = 'block';
            } else {
                console.log('没有可用的安装提示');
                // 显示一个提示，说明如何手动安装
                alert('要安装应用，请：\n1. 在Chrome中点击地址栏右侧的安装图标\n2. 或在Safari中点击分享按钮，选择"添加到主屏幕"');
            }
        }

        pwaInstallBtn.addEventListener('click', () => {
            pwaInstallPrompt.style.display = 'none';
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('用户接受了安装提示');
                    }
                    deferredPrompt = null;
                });
            } else {
                showInstallPrompt();
            }
        });

        pwaDismissBtn.addEventListener('click', () => {
            pwaInstallPrompt.style.display = 'none';
        });

        // 页面加载完成后检查PWA状态
        document.addEventListener('DOMContentLoaded', () => {
            console.log('PWA状态检查：');
            console.log('Service Worker支持:', 'serviceWorker' in navigator);
            console.log('安装提示支持:', 'beforeinstallprompt' in window);
            console.log('独立模式:', window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
        });
    </script>
</body>
</html>
